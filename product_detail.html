<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chi tiết Sản phẩm/Dịch vụ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --hotel-blue: #2c3e50; --hotel-gold: #c19b6c; }
        body { background-color: #f4f7f6; font-family: 'Segoe UI', sans-serif; }
        .navbar-hotel { background: var(--hotel-blue); color: white; padding: 15px; }
        .product-gallery img { cursor: pointer; border: 1px solid #ddd; margin-bottom: 10px; transition: border-color 0.3s; width: 80px; height: 80px; object-fit: cover; border-radius: 8px; }
        .product-gallery img:hover { border-color: var(--hotel-blue); }
        .main-image { border: 1px solid #eee; box-shadow: 0 5px 15px rgba(0,0,0,0.05); border-radius: 12px; }
        .price-display { color: var(--hotel-gold); font-weight: bold; font-size: 1.8rem; }
        .related-product-card { border: none; box-shadow: 0 2px 10px rgba(0,0,0,0.05); transition: transform 0.2s; }
        .related-product-card:hover { transform: translateY(-5px); }
        .btn-add-to-cart { background: var(--hotel-blue); color: white; border: none; padding: 12px; }
        .btn-add-to-cart:hover { background: #1a252f; color: white; }
        
        /* Star Rating Style */
        .rating { color: #f1c40f; font-size: 1.2rem; cursor: pointer; }
        .star-rating .fa-star { margin-right: 2px; }
        
        /* Quantity Input Style */
        .quantity-group { max-width: 130px; }
        .quantity-group input { text-align: center; border-left: 0; border-right: 0; font-weight: bold; }
    </style>
</head>
<body>

<nav class="navbar-hotel d-flex justify-content-between align-items-center shadow-sm mb-4">
    <a href="products.html" class="btn btn-outline-light btn-sm ms-3"><i class="fas fa-arrow-left me-2"></i>Quay lại</a>
    <h4 class="m-0"><i class="fas fa-hotel me-2"></i> Bình Minh</h4>
    <div class="pe-3"></div>
</nav>

<div class="container py-4">
    <div class="row">
        <div class="col-lg-8">
            <div class="card p-4 border-0 shadow-sm rounded-4">
                <div class="row">
                    <div class="col-md-6">
                        <img id="mainProductImage" src="https://via.placeholder.com/400" class="img-fluid main-image mb-3 w-100" alt="Main Product Image">
                        <div class="d-flex flex-wrap gap-2 product-gallery" id="productGallery"></div>
                    </div>
                    
                    <div class="col-md-6">
                        <h2 class="fw-bold mb-1" id="productName">Tên Sản phẩm</h2>
                        <div class="star-rating mb-2">
                            <span class="rating" id="productRating">
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star-half-alt"></i>
                            </span>
                            <small class="text-muted ms-2">(4.5/5 đánh giá)</small>
                        </div>
                        <p class="text-muted mb-3">Danh mục: <span id="productCategory" class="badge bg-secondary">---</span></p>
                        <h3 class="price-display mb-4" id="productPrice">0 VNĐ</h3>
                        <p class="text-secondary mb-4" id="productDescription">Đang tải mô tả...</p>

                        <div class="mb-4">
    <label class="form-label fw-bold"><i class="fas fa-door-open me-2"></i>Số phòng của bạn:</label>
    <input type="text" id="inputRoomNumber" class="form-control" placeholder="Ví dụ: 101, 202..." required>
    <small class="text-muted">Hệ thống sẽ ghi nhận dịch vụ vào hóa đơn của phòng này.</small>
</div>

<div class="d-grid">
    <button class="btn btn-add-to-cart btn-lg rounded-3" id="addToCartBtn">
        <i class="fas fa-shopping-cart me-2"></i>Thêm vào giỏ hàng
    </button>
    
</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <h5 class="fw-bold mb-3 mt-4 mt-lg-0">Dịch vụ tương tự</h5>
            <div id="relatedProductsList">
                <div class="text-center py-5"><div class="spinner-border text-primary" role="status"></div></div>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
   
    // Hàm thay đổi số lượng
    function changeQty(amt) {
        let qty = parseInt($('#quantity').val());
        qty = isNaN(qty) ? 1 : qty + amt;
        if (qty < 1) qty = 1;
        $('#quantity').val(qty);
    }

    $(document).ready(function() {
        
        const urlParams = new URLSearchParams(window.location.search);
        const productId = urlParams.get('id');

        if (!productId) {
            alert('Không tìm thấy ID sản phẩm!');
            window.location.href = 'products.html';
            return;
        }

        function loadProductDetail(id) {
            $.getJSON(`products_detail.php?action=get_detail&id=${id}`, function(data) {
                if (data && !data.error) {
                    $('#productName').text(data.ten_dich_vu);
                    $('#productCategory').text(data.ten_danh_muc);
                    $('#productPrice').text(data.gia.toLocaleString() + ' VNĐ');
                    $('#productDescription').text(data.mo_ta_chi_tiet);
                    $('#mainProductImage').attr('src', data.hinh_anh);
                    
                    // Lưu data vào nút để dùng khi thêm vào giỏ
                    $('#addToCartBtn').data('info', data);

                    // Xử lý Gallery
                    let galleryHtml = '';
                    let images = data.hinh_anh_phu && data.hinh_anh_phu.length > 0 ? data.hinh_anh_phu : [data.hinh_anh];
                    images.forEach(imgUrl => {
                        galleryHtml += `<img src="${imgUrl}" class="img-thumbnail" alt="Thumb">`;
                    });
                    $('#productGallery').html(galleryHtml);

                    $('.product-gallery img').click(function() {
                        $('#mainProductImage').fadeOut(200, () => {
                            $('#mainProductImage').attr('src', $(this).attr('src')).fadeIn(200);
                        });
                    });

                    // Sản phẩm tương tự
                    let relatedHtml = '';
                    if (data.san_pham_tuong_tu && data.san_pham_tuong_tu.length > 0) {
                        data.san_pham_tuong_tu.forEach(p => {
                            relatedHtml += `
                            <div class="card mb-3 related-product-card rounded-3">
                                <div class="row g-0 align-items-center">
                                    <div class="col-4">
                                        <img src="${p.hinh_anh}" class="img-fluid rounded-start" style="height: 90px; object-fit: cover; width: 100%;">
                                    </div>
                                    <div class="col-8">
                                        <div class="card-body py-2">
                                            <h6 class="card-title fw-bold mb-0 text-truncate">${p.ten_dich_vu}</h6>
                                            <p class="card-text text-gold small mb-1">${p.gia.toLocaleString()}đ</p>
                                            <a href="product_detail.html?id=${p.id}" class="btn btn-sm btn-link p-0 text-decoration-none text-primary">Chi tiết <i class="fas fa-chevron-right small"></i></a>
                                        </div>
                                    </div>
                                </div>
                            </div>`;
                        });
                    } else {
                        relatedHtml = '<p class="text-muted">Không có sản phẩm cùng loại.</p>';
                    }
                    $('#relatedProductsList').html(relatedHtml);

                } else {
                    alert('Sản phẩm không tồn tại!');
                    window.location.href = 'products.html';
                }
            }).fail(function() {
                alert('Lỗi hệ thống! Vui lòng thử lại.');
            });
        }

        loadProductDetail(productId);

        // Xử lý giỏ hàng
        // Thay thế đoạn xử lý click #addToCartBtn trong file HTML của bạn:
$('#addToCartBtn').click(function() {
    const data = $(this).data('info');
    const qty = parseInt($('#quantity').val());
    const roomNumber = $('#inputRoomNumber').val().trim(); // Lấy số phòng từ input

    // Kiểm tra nếu khách chưa nhập số phòng
    if (!roomNumber) {
        alert("Vui lòng nhập số phòng để chúng tôi phục vụ!");
        $('#inputRoomNumber').focus();
        return;
    }

    const postData = {
        action: 'add_to_service',
        RoomNumber: roomNumber,
        DichVuID: data.id,
        SoLuong: qty
    };

    const btn = $(this);
    const originalText = btn.html();
    btn.prop('disabled', true).text('Đang xử lý...');

    $.post('dich_vu_api.php', postData, function(res) {
        if (res.status === 'success') {
            // Hiệu ứng thành công
            btn.removeClass('btn-add-to-cart').addClass('btn-success')
               .html('<i class="fas fa-check"></i> Đã đặt thành công');
            
            alert(`Yêu cầu của phòng ${roomNumber} đã được gửi!`);
            
            setTimeout(() => {
                btn.prop('disabled', false).removeClass('btn-success')
                   .addClass('btn-add-to-cart').html(originalText);
            }, 3000);
        } else {
            alert('Lỗi: ' + res.message);
            btn.prop('disabled', false).html(originalText);
        }
    }, 'json').fail(function() {
        alert('Lỗi kết nối máy chủ!');
        btn.prop('disabled', false).html(originalText);
    });
});

// Hàm phụ để lưu vào local (giữ nguyên logic cũ của bạn)
function updateLocalStorage(data, qty) {
    let cart = JSON.parse(localStorage.getItem('hotel_cart') || '[]');
    const index = cart.findIndex(i => i.id === data.id);
    if (index > -1) {
        cart[index].qty += qty;
    } else {
        cart.push({ id: data.id, name: data.ten_dich_vu, price: data.gia, qty: qty });
    }
    localStorage.setItem('hotel_cart', JSON.stringify(cart));
}
            // Hiệu ứng thông báo đẹp hơn alert
            const btn = $(this);
            const originalText = btn.html();
            btn.prop('disabled', true).addClass('bg-success').html('<i class="fas fa-check"></i> Đã thêm vào giỏ');
            setTimeout(() => {
                btn.prop('disabled', false).removeClass('bg-success').html(originalText);
            }, 2000);
        });
 fetch("api/dich_vu_api.php", {
    method: "POST",
    headers: {
        "Content-Type": "application/json"
    },
    body: JSON.stringify({
        DatPhongID: datPhongID,   // ❗ KHÔNG phải số phòng
        DichVuID: 1,              // id dịch vụ
        SoLuong: 1,
        NgaySuDung: new Date().toISOString().slice(0, 10)
    })
})
.then(res => res.json())
.then(data => {
    alert(data.message);
});

</script>

</body>
</html>